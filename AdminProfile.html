<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Gym Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* Define your custom primary and secondary colors if not in tailwind.config.js */
        :root {
            --color-primary: #39FF14;
            /* Example green, adjust as needed */
            --color-secondary: #1A1A1A;
            /* Example blue, adjust as needed */
        }

        .bg-primary {
            background-color: var(--color-primary);
        }

        .text-primary {
            color: var(--color-primary);
        }

        .hover\:bg-primary-dark:hover {
            background-color: #000000;
            /* A darker shade of primary */
        }

        .bg-secondary {
            background-color: var(--color-secondary);
        }

        .text-secondary {
            color: var(--color-secondary);
        }

        .hover\:bg-secondary-dark:hover {
            background-color: #2563EB;
            /* A darker shade of secondary */
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #000;
            color: #e2e8f0;
        }
    </style>
</head>

<body>
    <div class="min-h-screen bg-black-900 py-10 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl font-extrabold text-white mb-8 text-center">My Profile</h2>

            <div id="profileDisplay" class="bg-gray-800 shadow-xl rounded-lg p-8 mb-8 border border-gray-700">
                <h3 class="text-2xl font-semibold text-white mb-6">Personal Information</h3>
                <div class="flex flex-col sm:flex-row items-center sm:space-x-8 mb-6">
                    <div
                        class="relative w-28 h-28 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 text-5xl flex-shrink-0 mb-4 sm:mb-0">
                        <i class="ri-user-smile-line"></i>
                    </div>

                    <div>
                        <p class="text-4xl font-bold text-white mb-2" id="profileFullName">Loading...</p>
                        <p class="text-lg text-gray-400 mb-1" id="profileRole">Loading...</p>
                        <p class="text-lg text-gray-400" id="profileEmail">Loading...</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8 text-gray-300 text-lg">
                    <p><strong>Phone:</strong> <span id="profilePhone">Loading...</span></p>
                    <p><strong>Date Joined:</strong> <span id="profileCreatedAt">Loading...</span></p>
                    <p><strong>Address:</strong> <span id="profileAddress">Loading...</span></p>
                    <p><strong>Last Login:</strong> <span id="profileLastLogin">Loading...</span></p>
                </div>

                <div class="mt-8 text-center sm:text-left">
                    <button id="editProfileBtn"
                        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        <i class="ri-edit-line mr-2"></i> Edit Profile
                    </button>
                </div>
            </div>

            <div id="editProfileFormContainer"
                class="hidden bg-gray-800 shadow-xl rounded-lg p-8 mb-8 border border-gray-700">
                <h3 class="text-2xl font-semibold text-white mb-6">Edit Personal Information</h3>
                <form id="editProfileForm" class="space-y-6">
                    <div>
                        <label for="editFullName" class="block text-sm font-medium text-gray-300">Full Name</label>
                        <input type="text" id="editFullName" name="fullName"
                            class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>
                    <div>
                        <label for="editEmail" class="block text-sm font-medium text-gray-300">Email Address</label>
                        <input type="email" id="editEmail" name="email" disabled
                            class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white cursor-not-allowed sm:text-sm">
                        <p class="mt-2 text-sm text-gray-400">Email cannot be changed.</p>
                    </div>
                    <div>
                        <label for="editPhone" class="block text-sm font-medium text-gray-300">Phone Number</label>
                        <input type="text" id="editPhone" name="phone"
                            class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>
                    <div>
                        <label for="editAddress" class="block text-sm font-medium text-gray-300">Address</label>
                        <textarea id="editAddress" name="address" rows="3"
                            class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"></textarea>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancelEditBtn"
                            class="px-6 py-3 border border-gray-600 text-base font-medium rounded-md shadow-sm text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-gray-800 shadow-xl rounded-lg p-8 mb-8 border border-gray-700">
                <h3 class="text-2xl font-semibold text-white mb-6">Account Settings</h3>
                <div class="space-y-4 text-lg">
                    <a href="/change-password.html"
                        class="flex items-center text-primary hover:text-primary-light transition duration-150 ease-in-out">
                        <i class="ri-lock-line mr-3"></i> Change Password
                    </a>
                    <a href="/notification-settings.html"
                        class="flex items-center text-primary hover:text-primary-light transition duration-150 ease-in-out">
                        <i class="ri-notification-line mr-3"></i> Notification Preferences
                    </a>
                    <a href="/privacy-settings.html"
                        class="flex items-center text-primary hover:text-primary-light transition duration-150 ease-in-out">
                        <i class="ri-shield-line mr-3"></i> Privacy Settings
                    </a>
                </div>
            </div>

            <div class="bg-red-900 bg-opacity-20 shadow-xl rounded-lg p-8 border border-red-800">
                <h3 class="text-2xl font-semibold text-red-400 mb-6">Danger Zone</h3>
                <p class="text-red-300 mb-6">
                    Proceed with caution. These actions are irreversible and may affect your account permanently.
                </p>
                <button id="deleteAccountBtn"
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <i class="ri-delete-bin-line mr-2"></i> Delete Account
                </button>
            </div>

        </div>
    </div>

    <script>
        // DOM elements
        const profileDisplay = document.getElementById('profileDisplay');
        const editProfileFormContainer = document.getElementById('editProfileFormContainer');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editProfileForm = document.getElementById('editProfileForm');

        // Edit form input fields
        const editFullNameInput = document.getElementById('editFullName');
        const editEmailInput = document.getElementById('editEmail');
        const editPhoneInput = document.getElementById('editPhone');
        const editAddressInput = document.getElementById('editAddress');

        document.addEventListener("DOMContentLoaded", async () => {
            await fetchUserProfile(); // Initial fetch on page load

            // Event listener for the "Edit Profile" button
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', () => {
                    profileDisplay.classList.add('hidden'); // Hide display section
                    editProfileFormContainer.classList.remove('hidden'); // Show edit form
                });
            }

            // Event listener for the "Cancel" button in the edit form
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    editProfileFormContainer.classList.add('hidden'); // Hide edit form
                    profileDisplay.classList.remove('hidden'); // Show display section
                });
            }

            // Event listener for the edit profile form submission
            if (editProfileForm) {
                editProfileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const token = localStorage.getItem("token");
                    if (!token) {
                        alert("Authentication token not found. Please log in.");
                        window.location.href = "sign_in_page.html";
                        return;
                    }

                    const updatedData = {
                        fullName: editFullNameInput.value.trim(),
                        // email: editEmailInput.value.trim(), // Email is disabled, typically not updated here
                        phone: editPhoneInput.value.trim(),
                        address: editAddressInput.value.trim(), // Get address from the edit form
                    };

                    try {
                        const response = await fetch("http://localhost:5000/api/user/profile", {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                "x-auth-token": token
                            },
                            body: JSON.stringify(updatedData)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            alert(result.message || "Profile updated successfully!");
                            editProfileFormContainer.classList.add('hidden'); // Hide edit form
                            profileDisplay.classList.remove('hidden'); // Show display section
                            await fetchUserProfile(); // Re-fetch and display updated profile
                        } else {
                            console.error("Failed to update profile:", result.message);
                            alert(`Failed to update profile: ${result.message || 'Unknown error'}`);
                        }
                    } catch (error) {
                        console.error("Error updating profile:", error);
                        alert("Network error or server unreachable. Please try again.");
                    }
                });
            }
        });

        // Function to fetch and display user profile
        async function fetchUserProfile() {
            const token = localStorage.getItem("token");

            if (!token) {
                alert("You are not logged in. Redirecting to login...");
                window.location.href = "sign_in.html";
                return;
            }

            try {
                const response = await fetch("http://localhost:5000/api/user/profile", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "x-auth-token": token
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    console.log("Fetched user data:", user);

                    // Populate display fields
                    document.getElementById('profileFullName').textContent = user.fullName || 'N/A';
                    document.getElementById('profileRole').textContent = user.role ? `${user.role.charAt(0).toUpperCase() + user.role.slice(1).toLowerCase()}` : 'N/A';
                    document.getElementById('profileEmail').textContent = user.email || 'N/A';
                    document.getElementById('profilePhone').textContent = user.phone || 'N/A';
                    document.getElementById('profileCreatedAt').textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                    document.getElementById('profileLastLogin').textContent = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'N/A';
                    document.getElementById('profileAddress').textContent = user.address || 'Not provided';

                    // Populate edit form fields
                    editFullNameInput.value = user.fullName || '';
                    editEmailInput.value = user.email || '';
                    editPhoneInput.value = user.phone || '';
                    editAddressInput.value = user.address || ''; // Populate address in the edit form

                } else {
                    const errorData = await response.json();
                    console.error("Failed to fetch profile:", errorData.message);
                    alert(`Failed to load profile: ${errorData.message || 'Unknown error'}. Redirecting to login.`);
                    localStorage.removeItem("token");
                    localStorage.removeItem("userRole");
                    window.location.href = "sign_in_page.html";
                }
            } catch (error) {
                console.error("Error fetching profile:", error);
                alert("Network error or server unreachable. Please try again.");
                localStorage.removeItem("token");
                localStorage.removeItem("userRole");
                window.location.href = "sign_in_page.html";
            }
        }

        // Optional: Logout functionality (add a logout button/link in your Admin Dashboard)
        // Ensure you have a button with id="logoutButton" in your HTML if you uncomment this
        /*
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            window.location.href = 'sign_in_page.html';
        });
        */

        // Add event listener for Delete Account button
        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                alert('Not logged in.');
                window.location.href = 'sign_in_page.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/user/account', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'Account deleted successfully.');
                    localStorage.removeItem('token');
                    localStorage.removeItem('userRole');
                    window.location.href = 'sign_up_page.html'; // Redirect to signup or home page
                } else {
                    alert(result.message || 'Failed to delete account.');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('An error occurred while trying to delete the account.');
            }
        });
    </script>
</body>

</html>